<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pivot Inspection (tech access)</title>
  <style>
    :root{
      --bg:#0f172a;
      --card:#111827;
      --card2:#0b1220;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --line:#1f2937;
      --good:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --pill:#1f2937;
      --btn:#2563eb;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:linear-gradient(180deg,#0b1020, #060915); color:var(--text)}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px 16px;background:rgba(17,24,39,.9);border:1px solid var(--line);border-radius:14px;position:sticky;top:10px;backdrop-filter: blur(8px); z-index:10}
    .title{font-weight:800;letter-spacing:.2px}
    .subtitle{color:var(--muted);font-size:13px}
    .card{background:rgba(17,24,39,.9);border:1px solid var(--line);border-radius:14px;padding:14px;margin-top:12px}
    .grid{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:720px){ .grid{grid-template-columns:repeat(3,1fr)} }
    label{display:block;font-size:12px;color:var(--muted);margin:2px 0 6px}
    input,select,textarea{width:100%;padding:10px 10px;border-radius:12px;border:1px solid #243041;background:#0b1220;color:var(--text)}
    textarea{min-height:70px;resize:vertical}
    .row{display:flex;gap:10px;align-items:end;flex-wrap:wrap}
    .icon-btn{border:1px solid #2b3647;background:#0b1220;color:var(--text);border-radius:12px;padding:10px 12px;cursor:pointer}
    .btn{border:0;border-radius:12px;padding:10px 12px;cursor:pointer;font-weight:700}
    .btn.primary{background:var(--btn);color:white}
    .btn.good{background:rgba(34,197,94,.15);color:#86efac;border:1px solid rgba(34,197,94,.25)}
    .btn.bad{background:rgba(239,68,68,.12);color:#fca5a5;border:1px solid rgba(239,68,68,.25)}
    .btn.gray{background:#111827;color:var(--text);border:1px solid #2b3647}
    .towers{display:flex;flex-direction:column;gap:12px}
    .tower-head{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:10px}
    .tower-title{font-weight:800}
    .components{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    @media(min-width:720px){ .components{grid-template-columns:repeat(3,1fr)} }
    .comp-btn{display:flex;align-items:center;gap:10px;background:#0b1220;border:1px solid #223047;border-radius:14px;padding:10px;cursor:pointer}
    .comp-btn img{width:44px;height:44px;object-fit:contain;background:rgba(255,255,255,.04);border-radius:12px;padding:6px}
    .comp-meta{display:flex;flex-direction:column;gap:3px;min-width:0}
    .comp-name{font-weight:700;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .comp-status{font-size:12px;color:var(--muted)}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;background:var(--pill);border:1px solid #2b3647}
    .pill.good{color:#86efac;border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.12)}
    .pill.bad{color:#fca5a5;border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.12)}
    .pill.warn{color:#fcd34d;border-color:rgba(245,158,11,.35);background:rgba(245,158,11,.12)}
    .pill.na{color:#cbd5e1;border-color:#334155;background:rgba(148,163,184,.08)}
    /* modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
    .modal{max-width:560px;width:100%;background:#0b1220;border:1px solid #243041;border-radius:16px;padding:14px}
    .modal h3{margin:0 0 10px}
    .modal .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
    .muted{color:var(--muted);font-size:12px}
    .small{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <div class="title">Pivot Inspection <span class="subtitle">(tech access)</span></div>
        <div class="subtitle">Tech-only form ‚Ä¢ saves to Supabase ‚Ä¢ optional PDF upload</div>
      </div>
      <div class="row">
        <input id="inspectionNumber" placeholder="Inspection #" style="width:140px" readonly />
        <button class="btn gray" type="button" id="btnAddTower">+ Tower</button>
      </div>
    </div>

    <div class="card">
      <div class="grid">
        <div>
          <label>Customer Name</label>
          <input id="customerName" placeholder="e.g., Bob the Farmer" />
        </div>

        <div>
          <label>Location</label>
          <div class="row" style="gap:8px">
            <input id="locationInput" placeholder="Field name or lat,long" />
            <button class="icon-btn" type="button" id="useLocationBtn" title="Use current location">üìç</button>
          </div>
          <div class="small">Tip: the üìç button fills lat/long if your browser allows it.</div>
        </div>

        <div>
          <label>Inspected By</label>
          <input id="inspectedBy" placeholder="Tech name" />
        </div>
      </div>
    </div>

    <div class="card">
      <div class="tower-head">
        <div>
          <div class="tower-title">Tower Inspections</div>
          <div class="muted">Tap a component ‚Üí set status ‚Üí it updates the report.</div>
        </div>
        <div class="row">
          <button class="btn gray" type="button" id="btnRemoveTower">Remove Last</button>
        </div>
      </div>
      <div id="towers" class="towers"></div>

      <div class="row" style="margin-top:12px;justify-content:flex-end">
        <button class="btn primary" type="button" id="btnSubmitInspection" onclick="submitInspection()">Submit Inspection</button>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
    <div class="modal">
      <h3 id="modalTitle">Component</h3>
      <div class="grid" style="grid-template-columns:1fr 1fr;gap:10px">
        <div>
          <label>Status</label>
          <select id="modalStatus">
            <option value="OK">OK</option>
            <option value="ATTN">Needs Attention</option>
            <option value="NA">N/A</option>
          </select>
        </div>
        <div>
          <label>Severity (optional)</label>
          <select id="modalSeverity">
            <option value="">‚Äî</option>
            <option value="WARN">Watch</option>
            <option value="BAD">Fix Now</option>
          </select>
        </div>
      </div>
      <div style="margin-top:10px">
        <label>Notes (optional)</label>
        <textarea id="modalNotes" placeholder="Short breadcrumb note..."></textarea>
      </div>
      <div class="actions">
        <button class="btn gray" type="button" id="modalCancel">Cancel</button>
        <button class="btn primary" type="button" id="modalSave">Save</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <script>
  // ----- Config: components shown per tower (images must exist in same folder) -----
  const COMPONENTS = [
    { key:"tire",          name:"Tire",           img:"tire.png" },
    { key:"wheel_gear",    name:"Wheel Gear",     img:"wheelgear.png" },
    { key:"drive_coupler", name:"Drive Coupler",  img:"drivecoupler.png" },
    { key:"driveline",     name:"Driveline",      img:"driveline.png" },
    { key:"driveline_cov", name:"Driveline Cover",img:"drivelinecover.png" },
    { key:"center_drive",  name:"Center Drive",   img:"centerdrive.png" },

    // NEW requested fields:
    { key:"tower_box",     name:"Tower Box",      img:"drivelinecover.png" },
    { key:"tower_boot",    name:"Tower Boot",     img:"driveline.png" },
  ];

  // ----- State -----
  const state = {
    towers: []
  };

  function makeTower(id){
    const comps = {};
    for(const c of COMPONENTS){
      comps[c.key] = { status:"OK", severity:"", notes:"" };
    }
    return { id, components: comps, comments:"" };
  }

  function pillClass(status, severity){
    if(status === "NA") return "na";
    if(status === "ATTN") return (severity === "WARN") ? "warn" : "bad";
    return "good";
  }

  // ----- Render -----
  const towersEl = document.getElementById("towers");

  function render(){
    towersEl.innerHTML = "";
    state.towers.forEach((t, idx) => {
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <div class="tower-head">
          <div>
            <div class="tower-title">Tower ${idx+1}</div>
            <div class="muted">Tap a component to set result.</div>
          </div>
          <div class="pill ${pillClass("OK","")}">#${idx+1}</div>
        </div>

        <div class="components"></div>

        <div style="margin-top:10px">
          <label>Tower Comments / Notes</label>
          <textarea class="tower-comment" placeholder="Notes for this tower..."></textarea>
        </div>
      `;
      const compsEl = card.querySelector(".components");
      for(const c of COMPONENTS){
        const v = t.components[c.key];
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "comp-btn";
        btn.innerHTML = `
          <img src="${c.img}" alt="">
          <div class="comp-meta">
            <div class="comp-name">${c.name}</div>
            <div class="comp-status"><span class="pill ${pillClass(v.status, v.severity)}">${labelFor(v)}</span></div>
          </div>
        `;
        btn.addEventListener("click", () => openComponentModal(t.id, c.key));
        compsEl.appendChild(btn);
      }

      const ta = card.querySelector(".tower-comment");
      ta.value = t.comments || "";
      ta.addEventListener("input", () => { t.comments = ta.value; });

      towersEl.appendChild(card);
    });
  }

  function labelFor(v){
    if(v.status === "NA") return "N/A";
    if(v.status === "ATTN"){
      if(v.severity === "WARN") return "Watch";
      return "Needs Attention";
    }
    return "OK";
  }

  // ----- Modal logic -----
  const modalBackdrop = document.getElementById("modalBackdrop");
  const modalTitle = document.getElementById("modalTitle");
  const modalStatus = document.getElementById("modalStatus");
  const modalSeverity = document.getElementById("modalSeverity");
  const modalNotes = document.getElementById("modalNotes");
  const modalCancel = document.getElementById("modalCancel");
  const modalSave = document.getElementById("modalSave");

  let modalCtx = { towerId:null, compKey:null };

  function openComponentModal(towerId, compKey){
    modalCtx = { towerId, compKey };
    const comp = COMPONENTS.find(x => x.key === compKey);
    const t = state.towers.find(x => x.id === towerId);
    const v = t.components[compKey];

    modalTitle.textContent = `Tower ${state.towers.indexOf(t)+1}: ${comp.name}`;
    modalStatus.value = v.status || "OK";
    modalSeverity.value = v.severity || "";
    modalNotes.value = v.notes || "";

    modalBackdrop.style.display = "flex";
    modalBackdrop.setAttribute("aria-hidden","false");
  }

  function closeModal(){
    modalBackdrop.style.display = "none";
    modalBackdrop.setAttribute("aria-hidden","true");
  }

  modalCancel.addEventListener("click", closeModal);
  modalBackdrop.addEventListener("click", (e)=>{ if(e.target === modalBackdrop) closeModal(); });

  modalSave.addEventListener("click", () => {
    const t = state.towers.find(x => x.id === modalCtx.towerId);
    if(!t) return closeModal();
    const v = t.components[modalCtx.compKey];

    v.status = modalStatus.value;
    v.severity = modalSeverity.value;
    v.notes = (modalNotes.value || "").trim();

    closeModal();
    render();
  });

  // ----- Add/remove tower -----
  function ensureAtLeastOneTower(){
    if(state.towers.length === 0){
      state.towers.push(makeTower(1));
    }
  }

  document.getElementById("btnAddTower").addEventListener("click", () => {
    const nextId = (state.towers[state.towers.length-1]?.id || 0) + 1;
    state.towers.push(makeTower(nextId));
    render();
  });

  document.getElementById("btnRemoveTower").addEventListener("click", () => {
    if(state.towers.length <= 1) return;
    state.towers.pop();
    render();
  });

  // ----- Geolocation -----
  document.addEventListener("DOMContentLoaded", () => {
    ensureAtLeastOneTower();
    render();

    const useLocationBtn = document.getElementById("useLocationBtn");
    const locationInput = document.getElementById("locationInput");

    useLocationBtn.addEventListener("click", () => {
      if (!navigator.geolocation) {
        alert("Geolocation not supported.");
        return;
      }
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const { latitude, longitude } = pos.coords;
          locationInput.value = `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
        },
        (err) => {
          alert("Unable to get current location: " + (err?.message || ""));
        },
        { enableHighAccuracy: true, timeout: 10000 }
      );
    });
  });

  // ----- Reports (HTML) -----
  function buildCustomerReportHTML(meta){
    const { customerName, location, inspectedBy, inspectionNumber } = meta;
    const rows = state.towers.map((t, idx) => {
      const pills = COMPONENTS.map(c => {
        const v = t.components[c.key];
        const cls = pillClass(v.status, v.severity);
        return `<span class="pill ${cls}" style="margin:2px 6px 2px 0;display:inline-block">${c.name}: ${labelFor(v)}</span>`;
      }).join("");
      const note = t.comments ? `<div style="margin-top:6px;color:#64748b;font-size:12px">Notes: ${escapeHtml(t.comments)}</div>` : "";
      return `
        <div style="padding:10px;border:1px solid #e5e7eb;border-radius:10px;margin:10px 0">
          <div style="font-weight:800;margin-bottom:6px">Tower ${idx+1}</div>
          <div>${pills}</div>
          ${note}
        </div>`;
    }).join("");

    return `
      <div style="font-family:Arial,sans-serif;color:#0f172a">
        <div style="border-bottom:2px solid #e5e7eb;padding-bottom:10px;margin-bottom:12px">
          <div style="font-size:20px;font-weight:900">Pivot Inspection Report</div>
          <div style="margin-top:6px;font-size:13px">
            <div><b>Customer:</b> ${escapeHtml(customerName)}</div>
            <div><b>Location:</b> ${escapeHtml(location)}</div>
            <div><b>Performed By:</b> ${escapeHtml(inspectedBy)}</div>
            <div><b>Inspection #:</b> ${escapeHtml(String(inspectionNumber || ""))}</div>
          </div>
        </div>
        ${rows}
      </div>
    `;
  }

  function buildTechReportHTML(meta){
    const { customerName, location, inspectedBy, inspectionNumber } = meta;
    const lines = [];
    state.towers.forEach((t, idx) => {
      lines.push(`<div style="margin-top:10px;font-weight:900">Tower ${idx+1}</div>`);
      COMPONENTS.forEach(c => {
        const v = t.components[c.key];
        const cls = pillClass(v.status, v.severity);
        const note = v.notes ? ` ‚Äî ${escapeHtml(v.notes)}` : "";
        lines.push(`<div style="margin:4px 0"><span style="font-weight:700">${c.name}:</span> <span style="color:${clsColor(cls)}">${escapeHtml(labelFor(v))}</span>${note}</div>`);
      });
      if(t.comments){
        lines.push(`<div style="margin:6px 0 0;color:#475569"><b>Tower notes:</b> ${escapeHtml(t.comments)}</div>`);
      }
    });

    return `
      <div style="font-family:Arial,sans-serif;color:#0f172a">
        <div style="border-bottom:2px solid #e5e7eb;padding-bottom:10px;margin-bottom:12px">
          <div style="font-size:20px;font-weight:900">Pivot Inspection (Tech Report)</div>
          <div style="margin-top:6px;font-size:13px">
            <div><b>Customer:</b> ${escapeHtml(customerName)}</div>
            <div><b>Location:</b> ${escapeHtml(location)}</div>
            <div><b>Performed By:</b> ${escapeHtml(inspectedBy)}</div>
            <div><b>Inspection #:</b> ${escapeHtml(String(inspectionNumber || ""))}</div>
          </div>
        </div>
        ${lines.join("")}
      </div>
    `;
  }

  function clsColor(cls){
    if(cls==="good") return "#16a34a";
    if(cls==="warn") return "#d97706";
    if(cls==="bad") return "#dc2626";
    return "#334155";
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // ----- PDF upload helpers (optional) -----
  async function htmlToPdfBlob(html, filenameBase){
    const holder = document.createElement("div");
    holder.style.position="fixed";
    holder.style.left="-10000px";
    holder.style.top="0";
    holder.style.width="800px";
    holder.innerHTML = html;
    document.body.appendChild(holder);

    const opt = {
      margin: 0.4,
      filename: `${filenameBase}.pdf`,
      html2canvas: { scale: 2 },
      jsPDF: { unit: "in", format: "letter", orientation: "portrait" }
    };

    const worker = html2pdf().from(holder).set(opt).toPdf();
    const pdf = await worker.get("pdf");
    const blob = pdf.output("blob");

    document.body.removeChild(holder);
    return blob;
  }

  async function blobToBase64(blob){
    const ab = await blob.arrayBuffer();
    let binary="";
    const bytes=new Uint8Array(ab);
    const chunk=0x8000;
    for(let i=0;i<bytes.length;i+=chunk){
      binary += String.fromCharCode.apply(null, bytes.subarray(i,i+chunk));
    }
    return btoa(binary);
  }

  async function tryUploadPdf({inspectionId, kind, blob, filename}){
    try{
      const base64 = await blobToBase64(blob);
      const res = await fetch("/.netlify/functions/upload-report", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
          inspection_id: inspectionId,
          kind,
          filename,
          contentType:"application/pdf",
          base64
        })
      });
      if(!res.ok){
        const t = await res.text().catch(()=> "");
        console.warn("Upload failed", res.status, t);
        return false;
      }
      return true;
    }catch(e){
      console.warn("Upload exception", e);
      return false;
    }
  }

  // ----- ONE submit function (global) -----
  window.submitInspection = async function () {
    const btn = document.getElementById("btnSubmitInspection");
    const old = btn.textContent;

    const customerName = (document.getElementById("customerName")?.value || "").trim();
    const location = (document.getElementById("locationInput")?.value || "").trim();
    const inspectedBy = (document.getElementById("inspectedBy")?.value || "").trim();

    if(!customerName || !location || !inspectedBy){
      alert("Please fill Customer Name, Location, and Inspected By.");
      return;
    }

    if(!confirm("Submit this inspection now?")) return;

    btn.disabled = true;
    btn.textContent = "Submitting‚Ä¶";

    try{
      // Build report HTMLs
      const meta = { customerName, location, inspectedBy, inspectionNumber: document.getElementById("inspectionNumber")?.value || "" };
      const customer_report_html = buildCustomerReportHTML(meta);
      const tech_report_html = buildTechReportHTML(meta);

      // Insert inspection row
      const res = await fetch("/.netlify/functions/submit-inspection", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
          customer_name: customerName,
          location,
          performed_by: inspectedBy,
          duration_minutes: 0
          // NOTE: not sending unknown columns here to avoid insert errors
        })
      });

      const json = await res.json().catch(()=>null);
      if(!res.ok){
        const details = json ? JSON.stringify(json) : ("HTTP "+res.status);
        throw new Error(details);
      }

      const row = json?.inserted?.[0] || null;
      const inspectionId = row?.id;
      const inspNum = row?.inspection_number;

      if(inspNum !== undefined && inspNum !== null){
        const inp = document.getElementById("inspectionNumber");
        if(inp) inp.value = inspNum;
        meta.inspectionNumber = inspNum;
      }

      // Optional: try to upload PDFs if upload-report function exists
      if(inspectionId){
        const custBlob = await htmlToPdfBlob(customer_report_html, `Inspection-${inspNum||"X"}-Customer`);
        const techBlob = await htmlToPdfBlob(tech_report_html, `Inspection-${inspNum||"X"}-Tech`);

        await tryUploadPdf({ inspectionId, kind:"customer", blob:custBlob, filename:`Inspection-${inspNum||"X"}-Customer.pdf` });
        await tryUploadPdf({ inspectionId, kind:"tech", blob:techBlob, filename:`Inspection-${inspNum||"X"}-Tech.pdf` });
      }

      alert(`Inspection saved! #${inspNum ?? ""}`);
    }catch(err){
      alert("Submit failed:\n" + (err?.message || String(err)));
    }finally{
      btn.disabled = false;
      btn.textContent = old;
    }
  };
  </script>
</body>
</html>
