<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Pivot Inspection (Tech Access)</title>
<style>
  :root {
    --brand: #1865ab;
    --bg: #f5f5f5;
    --card: #ffffff;
    --text: #212529;
    --muted: #6c757d;
    --good: #4caf50;
    --warn: #ffc107;
    --bad:  #f44336;
    --border: #dee2e6;
  }
  *{box-sizing:border-box;}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;padding:16px;background:var(--bg);color:var(--text);}
  h1{margin:0 0 12px;text-align:center;font-size:1.45rem;}
  .container{max-width:1100px;margin:0 auto;}
  .section-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px 14px;margin-bottom:12px;box-shadow:0 1px 6px rgba(0,0,0,0.08);}
  .section-title{font-weight:900;color:#343a40;margin-bottom:8px;}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px 14px;}
  label{display:block;font-size:.82rem;font-weight:900;color:#495057;margin-bottom:4px;}
  input,select,textarea{width:100%;font-size:.95rem;padding:8px 10px;border-radius:10px;border:1px solid #ced4da;background:#fff;}
  textarea{min-height:44px;resize:vertical;}
  .row{display:flex;gap:8px;align-items:center;}
  .icon-btn{width:44px;height:44px;border-radius:10px;border:1px solid #ced4da;background:#e9ecef;cursor:pointer;font-size:18px;}

  .report-actions{display:flex;flex-wrap:wrap;gap:10px;justify-content:flex-end;}
  .btn{border:none;border-radius:10px;padding:10px 14px;cursor:pointer;font-weight:900;font-size:.86rem;color:#fff;background:var(--brand);}
  .btn.secondary{background:#495057;}
  .btn:active{transform:translateY(1px);}

  .tower-canvas-frame{width:100%;overflow:visible;}
  .tower-canvas-scale{width:1000px;height:420px;transform-origin:top left;}
  .tower-layout{position:relative;width:1000px;height:420px;border:1px solid #ccc;border-radius:12px;background:#fafafa;overflow:hidden;}

  .hotspot{position:absolute;border:none;background:transparent;cursor:pointer;padding:0;display:flex;align-items:center;justify-content:center;transition:transform .12s ease, box-shadow .12s ease, background-color .12s ease;border-radius:999px;}
  .hotspot:hover{transform:scale(1.08);box-shadow:0 0 6px rgba(0,0,0,.35);}
  .hotspot-img{width:100%;height:100%;object-fit:contain;pointer-events:none;filter:brightness(0) contrast(1);}

  .hotspot.status-good{background-color:rgba(76,175,80,.16);box-shadow:0 0 8px rgba(76,175,80,.85);}
  .hotspot.status-warning{background-color:rgba(255,193,7,.18);box-shadow:0 0 8px rgba(255,193,7,.90);}
  .hotspot.status-bad{background-color:rgba(244,67,54,.18);box-shadow:0 0 8px rgba(244,67,54,.95);}

  .hotspot.status-good .hotspot-img{filter:brightness(0) sepia(1) hue-rotate(90deg) saturate(7);}
  .hotspot.status-warning .hotspot-img{filter:brightness(0) sepia(1) hue-rotate(25deg) saturate(7);}
  .hotspot.status-bad .hotspot-img{filter:brightness(0) sepia(1) hue-rotate(-10deg) saturate(10);}

  .component-card{position:absolute;min-width:250px;max-width:290px;border-radius:12px;overflow:hidden;border:1px solid #cfd4da;box-shadow:0 8px 18px rgba(0,0,0,.22);background:#fff;font-size:.95rem;display:none;z-index:50;}
  .component-card.active{display:block;}
  .component-card-header{background:#0b2a4a;color:#fff;padding:10px 12px;font-weight:900;display:flex;justify-content:space-between;align-items:center;}
  .close-btn{background:transparent;border:none;color:#fff;font-size:20px;cursor:pointer;}
  .component-card-body{background:#e9ecef;padding:10px 12px 12px;}
  .options-row{display:flex;flex-wrap:wrap;gap:8px;}
  .option-btn{padding:7px 10px;border-radius:999px;border:1px solid #adb5bd;background:#fff;cursor:pointer;font-size:.82rem;font-weight:900;line-height:1.1;display:inline-flex;align-items:center;gap:8px;}
  .option-dot{width:10px;height:10px;border-radius:50%;border:1px solid #ced4da;background:#fff;}
  .option-btn.selected{border-width:2px;}
  .option-btn.status-good .option-dot{background:var(--good);border-color:var(--good);}
  .option-btn.status-warning .option-dot{background:var(--warn);border-color:var(--warn);}
  .option-btn.status-bad .option-dot{background:var(--bad);border-color:var(--bad);}
  .option-btn.status-good.selected{background:rgba(76,175,80,.12);}
  .option-btn.status-warning.selected{background:rgba(255,193,7,.18);}
  .option-btn.status-bad.selected{background:rgba(244,67,54,.12);}
  .psi-row{margin-top:10px;display:none;}
  .psi-row small{color:var(--muted);display:block;margin-top:4px;}
  .psi-error{margin-top:6px;font-size:.82rem;color:#c92a2a;display:none;}

  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:16px;z-index:200;}
  .modal-backdrop.active{display:flex;}
  .modal{width:min(560px,100%);background:#fff;border-radius:14px;overflow:hidden;border:1px solid var(--border);box-shadow:0 10px 28px rgba(0,0,0,.25);}
  .modal-header{background:var(--brand);color:#fff;padding:12px 14px;font-weight:900;display:flex;justify-content:space-between;align-items:center;}
  .modal-body{padding:12px 14px 14px;}
  .modal-actions{display:flex;flex-wrap:wrap;gap:10px;justify-content:flex-end;}
  .hint{color:var(--muted);font-size:.85rem;margin-top:8px;}

  .brand-header{border-bottom:3px solid var(--brand);padding-bottom:.5rem;margin-bottom:1rem;}
  .brand-title{font-size:1.5rem;font-weight:900;color:var(--brand);}
  .brand-sub{font-size:.92rem;color:#495057;}
  .cover-card{border:1px solid var(--border);border-radius:12px;padding:.85rem 1rem;margin-bottom:1rem;background:#f8f9fa;}
  .info-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:.45rem 1rem;font-size:.95rem;}
  .info-label{font-weight:900;color:#343a40;font-size:.82rem;}
  .report-section-title{font-size:1.05rem;font-weight:900;margin:.7rem 0 .35rem;color:#343a40;}
  .tower-card{border:1px solid var(--border);border-radius:12px;padding:.6rem .8rem;margin-bottom:.65rem;}
  .tower-header-report{font-weight:900;margin-bottom:.35rem;color:var(--brand);}
  .report-table{width:100%;border-collapse:collapse;font-size:.88rem;}
  .report-table th,.report-table td{border:1px solid var(--border);padding:.3rem .42rem;text-align:left;}
  .report-table th{background:#f1f3f5;}
  .small-note{font-size:.82rem;color:#868e96;margin-top:.35rem;}
  .notes-block{font-size:.9rem;margin-bottom:.4rem;}
  .notes-block strong{display:inline-block;width:190px;}
  .report-toolbar{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;margin:0 0 1rem;padding:.55rem .8rem;background:#f1f3f5;border:1px solid var(--border);border-radius:12px;}
  .toolbar-btn{border:none;border-radius:10px;padding:.55rem .85rem;cursor:pointer;background:var(--brand);color:#fff;font-weight:900;font-size:.84rem;}
  .toolbar-btn.secondary{background:#495057;}

  .status-pill{display:inline-block;padding:.14rem .6rem;border-radius:999px;font-size:.78rem;font-weight:900;line-height:1;border:2px solid transparent;-webkit-print-color-adjust:exact !important;print-color-adjust:exact !important;}
  .pill-good{background:#4caf50 !important;border-color:#2e7d32 !important;color:#fff !important;}
  .pill-warn{background:#ffc107 !important;border-color:#b08900 !important;color:#212529 !important;}
  .pill-bad{background:#f44336 !important;border-color:#b71c1c !important;color:#fff !important;}
  @media print{*{-webkit-print-color-adjust:exact !important;print-color-adjust:exact !important;} .status-pill{background-clip:padding-box !important;box-shadow:none !important;}}
  @media (max-width:480px){body{padding:12px;} .section-card{padding:10px 12px;} .btn{width:100%;} .report-actions{justify-content:stretch;}}

  .select-good{border-color:#2e7d32 !important; box-shadow:0 0 0 2px rgba(76,175,80,.18) inset;}
  .select-warn{border-color:#b08900 !important; box-shadow:0 0 0 2px rgba(255,193,7,.22) inset;}
  .select-bad{border-color:#b71c1c !important; box-shadow:0 0 0 2px rgba(244,67,54,.18) inset;}

</style>
</head>
<body>
<div class="container">
  <h1>Pivot Inspection <span style="font-weight:700;color:#495057;">(Tech Access)</span></h1>

  <div class="section-card">
    <div class="section-title">General Information</div>
    <div class="grid">
      <div><label for="customerName">Customer Name / Company</label><input id="customerName" type="text" /></div>
      <div><label for="systemBrand">System Brand</label>
        <select id="systemBrand">
          <option value="">Select brand...</option><option value="Reinke">Reinke</option><option value="Valley">Valley</option>
          <option value="Zimmatic">Zimmatic</option><option value="T&L">T&amp;L</option><option value="Other">Other</option>
        </select>
      </div>
      <div><label for="inspectedBy">Inspection Performed By</label><input id="inspectedBy" type="text" /></div>
      <div><label for="fieldName">Field Name</label><input id="fieldName" type="text" /></div>
      <div><label for="locationInput">Location</label>
        <div class="row">
          <input id="locationInput" type="text" />
          <button class="icon-btn" type="button" id="useLocationBtn" title="Use current location">üìç</button>
        </div>
      </div>
      <div><label for="inspectionDate">Date of Inspection</label><input id="inspectionDate" type="date" /></div>
      <div><label for="machineHours">Hours on Machine</label><input id="machineHours" type="number" min="0" step="1" /></div>
      <div><label for="startTime">Start Time</label><input id="startTime" type="time" /></div>
      <div><label for="endTime">End Time</label><input id="endTime" type="time" /></div>
    </div>
  </div>

  <div class="section-card">
    <div class="section-title">Notes &amp; Quick Findings</div>
    <div class="grid">
      <div><label for="wellMotorOil">Well Motor Oil Level</label><textarea id="wellMotorOil"></textarea></div>
      <div><label for="dripOilSystem">Drip Oil System</label><textarea id="dripOilSystem"></textarea></div>
      <div><label for="WellPanel">Well Panel</label><textarea id="WellPanel"></textarea></div>
      <div><label for="waterSupply">Water Supply</label><textarea id="waterSupply"></textarea></div>
      <div><label for="mainControlPanel">Main Control Panel</label><textarea id="mainControlPanel"></textarea></div>
      <div><label for="pivotFoundation">Pivot Foundation</label><textarea id="pivotFoundation"></textarea></div>
      <div><label for="anchoringSystem">Anchoring System</label><textarea id="anchoringSystem"></textarea></div>
      <div><label for="centerPointStructure">Center Point Structure</label><textarea id="centerPointStructure"></textarea></div>
      <div><label for="collectorRing">Collector Ring</label><textarea id="collectorRing"></textarea></div>
      <div><label for="towerBootNote">Tower Boot</label><textarea id="towerBootNote"></textarea></div>
    </div>
  </div>

  <div id="towersContainer"></div>

  <div class="section-card">
    <div class="section-title">Tech Submit</div>
    <div class="hint">Submit is locked until required fields are filled. After submit, PDFs are generated and uploaded to Supabase Storage.</div>
    <div class="report-actions" style="margin-top:10px;">
      <button class="btn" type="button" id="btnSubmitInspection">Submit Inspection</button>
    </div>
  </div>

  </div>
<!-- Tower template + component card + report modal identical to your working app -->
<!-- To keep this message readable, I‚Äôm using the same tower template and JS logic as your working file. -->
<!-- ‚úÖ IMPORTANT: You already have these working. We will not alter tower positions. -->

<template id="towerTemplate">
  <div class="section-card tower-section">
    <div class="section-title">Tower Inspection ‚Äì Tower <span class="tower-number">1</span></div>

    <div class="tower-canvas-frame">
      <div class="tower-canvas-scale">
        <div class="tower-layout">
          <button class="hotspot" type="button" data-component="reverseTire" style="left:221.344px; top:284.016px; width:120px; height:120px;"><img class="hotspot-img" src="tire.png" /></button>
          <button class="hotspot" type="button" data-component="reverseWheelGear" style="left:149.266px; top:253.016px; width:80px; height:80px;"><img class="hotspot-img" src="wheelgear.png" /></button>
          <button class="hotspot" type="button" data-component="reverseWheelCoupler" style="left:196.781px; top:220.297px; width:70px; height:60px;"><img class="hotspot-img" src="drivecoupler.png" /></button>
          <button class="hotspot" type="button" data-component="reverseDriveLine" style="left:243.859px; top:190.375px; width:140px; height:40px; border-radius:12px;"><img class="hotspot-img" src="driveline.png" /></button>
          <button class="hotspot" type="button" data-component="reverseDriveLineCover" style="left:301.688px; top:205.984px; width:180px; height:60px; border-radius:14px;"><img class="hotspot-img" src="drivelinecover.png" /></button>
          <button class="hotspot" type="button" data-component="centerReverseCoupler" style="left:483.344px; top:104.875px; width:70px; height:60px;"><img class="hotspot-img" src="drivecoupler.png" /></button>
          <button class="hotspot" type="button" data-component="centerDrive" style="left:415.25px; top:100.719px; width:90px; height:70px;"><img class="hotspot-img" src="centerdrive.png" /></button>
          <button class="hotspot" type="button" data-component="centerForwardCoupler" style="left:630.828px; top:32.641px; width:70px; height:60px;"><img class="hotspot-img" src="drivecoupler.png" /></button>
          <button class="hotspot" type="button" data-component="forwardDriveLineCover" style="left:523.062px; top:100.797px; width:200px; height:60px; border-radius:14px;"><img class="hotspot-img" src="drivelinecover.png" /></button>
          <button class="hotspot" type="button" data-component="forwardDriveLine" style="left:529.094px; top:76.297px; width:140px; height:40px; border-radius:12px;"><img class="hotspot-img" src="driveline.png" /></button>
          <button class="hotspot" type="button" data-component="forwardWheelCoupler" style="left:346.984px; top:146.875px; width:70px; height:60px;"><img class="hotspot-img" src="drivecoupler.png" /></button>
          <button class="hotspot" type="button" data-component="forwardWheelGear" style="left:708.234px; top:6.922px; width:80px; height:80px;"><img class="hotspot-img" src="wheelgear.png" /></button>
          <button class="hotspot" type="button" data-component="forwardTire" style="left:770.641px; top:35.062px; width:120px; height:120px;"><img class="hotspot-img" src="tire.png" /></button>
        </div>
      </div>
    </div>

    <div class="grid" style="margin-top:10px;">
      <div>
        <label>Tower Boot</label>
        <select class="towerBootSelect">
          <option value="">Select...</option>
          <option value="Good">Good</option>
          <option value="Cracking">Cracking</option>
          <option value="Replace">Replace</option>
        </select>
      </div>
      <div>
        <label>Tower Box</label>
        <select class="towerBoxSelect">
          <option value="">Select...</option>
          <option value="Good">Good</option>
          <option value="Replace Contactor & Micro-switch">Replace Contactor & Micro-switch</option>
          <option value="Cracked Lid">Cracked Lid</option>
          <option value="Replace">Replace</option>
        </select>
      </div>
    </div>


    <div style="margin-top:10px;">
      <label>Tower Comments / Notes</label>
      <textarea class="tower-comment"></textarea>
    </div>

    <div class="report-actions" style="margin-top:10px;">
      <button class="btn good" type="button">+ Add Tower</button>
      <button class="btn bad" type="button">Remove Tower</button>
    </div>
  </div>
</template>

<div id="componentCard" class="component-card" aria-hidden="true">
  <div class="component-card-header">
    <span id="cardTitle">Component</span>
    <button type="button" class="close-btn" id="closeCardBtn" aria-label="Close">√ó</button>
  </div>
  <div class="component-card-body">
    <div class="options-row" id="optionsRow"></div>
    <div class="psi-row" id="psiRow">
      <label for="psiInput">Tire Pressure (PSI)</label>
      <input type="number" id="psiInput" min="0" step="1" />
      <small>Enter PSI first, then choose a condition.</small>
      <div class="psi-error" id="psiError">Enter PSI and choose a condition to continue.</div>
    </div>
  </div>
</div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
(() => {
  const selections = {};
  const componentConfigs = {
    reverseTire:{label:'Reverse Tire',type:'tire',options:[{label:'Good',status:'good'},{label:'Low PSI',status:'warning'},{label:'Flat / Severe Cracking',status:'bad'}]},
    forwardTire:{label:'Forward Tire',type:'tire',options:[{label:'Good',status:'good'},{label:'Low PSI',status:'warning'},{label:'Flat / Severe Cracking',status:'bad'}]},
    reverseWheelGear:{label:'Reverse Wheel Gear',type:'normal',options:[{label:'Good',status:'good'},{label:'Low Oil',status:'warning'},{label:'Input Shaft Leaking',status:'warning'},{label:'Output Shaft Leaking',status:'bad'},{label:'Replace',status:'bad'}]},
    forwardWheelGear:{label:'Forward Wheel Gear',type:'normal',options:[{label:'Good',status:'good'},{label:'Low Oil',status:'warning'},{label:'Input Shaft Leaking',status:'warning'},{label:'Output Shaft Leaking',status:'bad'},{label:'Replace',status:'bad'}]},
    reverseWheelCoupler:{label:'Reverse Wheel Coupler',type:'normal',options:[{label:'Good',status:'good'},{label:'Worn',status:'warning'},{label:'Replace',status:'bad'}]},
    forwardWheelCoupler:{label:'Forward Wheel Coupler',type:'normal',options:[{label:'Good',status:'good'},{label:'Worn',status:'warning'},{label:'Replace',status:'bad'}]},
    reverseDriveLine:{label:'Reverse Drive Line',type:'normal',options:[{label:'Good',status:'good'},{label:'Replace',status:'bad'}]},
    forwardDriveLine:{label:'Forward Drive Line',type:'normal',options:[{label:'Good',status:'good'},{label:'Replace',status:'bad'}]},
    reverseDriveLineCover:{label:'Reverse Drive Line Cover',type:'normal',options:[{label:'Good',status:'good'},{label:'Replace',status:'bad'}]},
    forwardDriveLineCover:{label:'Forward Drive Line Cover',type:'normal',options:[{label:'Good',status:'good'},{label:'Replace',status:'bad'}]},
    centerReverseCoupler:{label:'Center Drive Reverse Coupler',type:'normal',options:[{label:'Good',status:'good'},{label:'Worn',status:'warning'},{label:'Replace',status:'bad'}]},
    centerForwardCoupler:{label:'Center Drive Forward Coupler',type:'normal',options:[{label:'Good',status:'good'},{label:'Worn',status:'warning'},{label:'Replace',status:'bad'}]},
    centerDrive:{label:'Center Drive',type:'normal',options:[{label:'Good',status:'good'},{label:'Low Oil',status:'warning'},{label:'Output Shaft Leaking',status:'warning'},{label:'Replace',status:'bad'}]},
  };

  const towersContainer = document.getElementById('towersContainer');
  const towerTemplate = document.getElementById('towerTemplate');

  const card = document.getElementById('componentCard');
  const cardTitle = document.getElementById('cardTitle');
  const optionsRow = document.getElementById('optionsRow');
  const psiRow = document.getElementById('psiRow');
  const psiInput = document.getElementById('psiInput');
  const psiError = document.getElementById('psiError');
  const closeCardBtn = document.getElementById('closeCardBtn');

  const useLocationBtn = document.getElementById('useLocationBtn');
  const locationInput = document.getElementById('locationInput');

  function clearStatus(el){ el.classList.remove('status-good','status-warning','status-bad'); }

  function updateTowerScale(){
    document.querySelectorAll('.tower-section').forEach(section => {
      const frame = section.querySelector('.tower-canvas-frame');
      const scaleEl = section.querySelector('.tower-canvas-scale');
      if(!frame||!scaleEl) return;
      const w = frame.clientWidth || 1000;
      const s = Math.min(1, w / 1000);
      scaleEl.style.transform = `scale(${s})`;
      frame.style.height = (420*s)+'px';
    });
  }
  window.addEventListener('resize', updateTowerScale);

  function closeCard(){ card.classList.remove('active'); card.setAttribute('aria-hidden','true'); }
  closeCardBtn.addEventListener('click', closeCard);

  function openCardForComponent(towerId, componentId, hotspotEl, canvasEl){
    const cfg = componentConfigs[componentId]; if(!cfg) return;
    canvasEl.appendChild(card);
    cardTitle.textContent = `${cfg.label} ‚Äì Tower ${towerId}`;
    optionsRow.innerHTML = '';
    const existing = selections[towerId]?.[componentId] || null;

    cfg.options.forEach(opt => {
      const b = document.createElement('button');
      b.type='button';
      b.className=`option-btn status-${opt.status}`;
      const dot=document.createElement('span'); dot.className='option-dot';
      const text=document.createElement('span'); text.textContent=opt.label;
      b.appendChild(dot); b.appendChild(text);
      if(existing && existing.condition===opt.label) b.classList.add('selected');
      b.addEventListener('click',()=>handleOptionSelect(towerId,componentId,hotspotEl,opt.status,opt.label,b));
      optionsRow.appendChild(b);
    });

    if(cfg.type==='tire'){
      psiRow.style.display='block';
      psiInput.value=existing?.psi||'';
      psiError.style.display='none';
    } else {
      psiRow.style.display='none';
      psiInput.value='';
      psiError.style.display='none';
    }

    const canvasRect = canvasEl.getBoundingClientRect();
    const hotRect = hotspotEl.getBoundingClientRect();
    const scaleWrap = canvasEl.closest('.tower-canvas-scale');
    let scale=1;
    if(scaleWrap){
      const m=getComputedStyle(scaleWrap).transform;
      if(m && m!=='none'){
        const parts=m.match(/matrix\(([^)]+)\)/);
        if(parts && parts[1]){
          const nums=parts[1].split(',').map(x=>parseFloat(x.trim()));
          if(nums.length && !isNaN(nums[0])) scale=nums[0];
        }
      }
    }
    let left=(hotRect.right-canvasRect.left)/scale+10;
    let top=(hotRect.top-canvasRect.top)/scale-10;
    left=Math.max(0,Math.min(left,1000-300));
    top=Math.max(0,Math.min(top,420-190));
    card.style.left=left+'px';
    card.style.top=top+'px';
    card.classList.add('active');
    card.setAttribute('aria-hidden','false');
  }

  function handleOptionSelect(towerId, componentId, hotspotEl, status, label, btnEl){
    const cfg=componentConfigs[componentId]; if(!cfg) return;
    let finalStatus=status;

    if(cfg.type==='tire'){
      const psiVal=psiInput.value.trim();
      const psiNum=psiVal?parseFloat(psiVal):NaN;
      if(!psiVal || isNaN(psiNum)){ psiError.style.display='block'; psiInput.focus(); return; }
      psiError.style.display='none';
      selections[towerId]=selections[towerId]||{};
      selections[towerId][componentId]=selections[towerId][componentId]||{};
      selections[towerId][componentId].psi=psiVal;
      if(psiNum<20 && finalStatus==='good') finalStatus='warning';
    }

    optionsRow.querySelectorAll('.option-btn').forEach(b=>b.classList.remove('selected'));
    btnEl.classList.add('selected');
    clearStatus(hotspotEl);
    hotspotEl.classList.add(`status-${finalStatus}`);
    selections[towerId]=selections[towerId]||{};
    selections[towerId][componentId]=selections[towerId][componentId]||{};
    selections[towerId][componentId].condition=label;
    selections[towerId][componentId].status=finalStatus;
    closeCard();
  }

  function addTower(){
    towerCounter+=1;
    const frag=towerTemplate.content.cloneNode(true);
    const section=frag.querySelector('.tower-section');
    frag.querySelector('.tower-number').textContent=String(towerCounter);
    section.dataset.towerId=String(towerCounter);
    towersContainer.appendChild(section);

    const canvas=section.querySelector('.tower-layout');
    canvas.querySelectorAll('.hotspot').forEach(h=>{
      const compId=h.dataset.component;
      h.addEventListener('click',()=>openCardForComponent(towerCounter,compId,h,canvas));
    });

    section.querySelector('.btn.good').addEventListener('click', addTower);
    section.querySelector('.btn.bad').addEventListener('click',()=>{
      const sections=Array.from(towersContainer.querySelectorAll('.tower-section'));
      if(sections.length<=1){ alert('At least one tower is required.'); return; }
      section.remove(); updateTowerScale();
    });

    updateTowerScale();
  }
  addTower();

  document.addEventListener('click',(e)=>{
    if(!card.classList.contains('active')) return;
    if(card.contains(e.target)) return;
    if(e.target.closest('.hotspot')) return;
    closeCard();
  });

  useLocationBtn.addEventListener('click',()=>{
    if(!navigator.geolocation){ alert('Geolocation not supported.'); return; }
    navigator.geolocation.getCurrentPosition(
      pos => { const {latitude,longitude}=pos.coords; locationInput.value=`${latitude.toFixed(6)}, ${longitude.toFixed(6)}`; },
      () => alert('Unable to get current location.')
    );
  });

  function gatherFormData(){
    const data={
      customerName:document.getElementById('customerName').value||'',
      systemBrand:document.getElementById('systemBrand').value||'',
      inspectedBy:document.getElementById('inspectedBy').value||'',
      fieldName:document.getElementById('fieldName').value||'',
      location:document.getElementById('locationInput').value||'',
      inspectionDate:document.getElementById('inspectionDate').value||'',
      machineHours:document.getElementById('machineHours').value||'',
      startTime:document.getElementById('startTime').value||'',
      endTime:document.getElementById('endTime').value||'',
      notes:{
        wellMotorOil:document.getElementById('wellMotorOil').value||'',
        dripOilSystem:document.getElementById('dripOilSystem').value||'',
        wellPanel:document.getElementById('WellPanel').value||'',
        waterSupply:document.getElementById('waterSupply').value||'',
        mainControlPanel:document.getElementById('mainControlPanel').value||'',
        pivotFoundation:document.getElementById('pivotFoundation').value||'',
        anchoringSystem:document.getElementById('anchoringSystem').value||'',
        centerPointStructure:document.getElementById('centerPointStructure').value||'',
        collectorRing:document.getElementById('collectorRing').value||'',
        towerBootNote:document.getElementById('towerBootNote').value||'',
      },
      towers:[]
    };
    towersContainer.querySelectorAll('.tower-section').forEach(section=>{
      const towerId=parseInt(section.dataset.towerId,10);
      const comment=section.querySelector('.tower-comment')?.value||'';
      data.towers.push({id:towerId, comment, components: selections[towerId]||{}});
    });
    return data;
  }

  function escapeHtml(str){
    return String(str).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
      .replaceAll('"','&quot;').replaceAll("'","&#039;");
  }
  function infoItem(label,value){
    const v=(value||'').toString().trim();
    return `<div><div class="info-label">${escapeHtml(label)}</div><div>${v?escapeHtml(v):'<span class="small-note">‚Äî</span>'}</div></div>`;
  }
  function noteRow(label,value){
    const v=(value||'').toString().trim();
    if(!v) return '';
    return `<div><strong>${escapeHtml(label)}:</strong> ${escapeHtml(v)}</div>`;
  }

  function buildCustomerReportHtml(includeProblemsOnly){
    const data=gatherFormData();
    let html=`
      <div class="report-toolbar">
        <button class="toolbar-btn" onclick="window.print()">Print / Save as PDF</button>
        <button class="toolbar-btn secondary" onclick="window.close()">Close</button>
        <div class="small-note" style="margin-left:auto;">Tip: choose ‚ÄúSave as PDF‚Äù.</div>
      </div>
      <div class="brand-header">
        <div class="brand-title">Pracht Irrigation ‚Äì Pivot Inspection Report</div>
        <div class="brand-sub">Customer-facing summary of inspection findings</div>
      </div>
      <div class="cover-card">
        <h2 style="margin:.1rem 0 .55rem;">Inspection Summary</h2>
        <div class="info-grid">
          ${infoItem('Customer / Company', data.customerName)}
          ${infoItem('System Brand', data.systemBrand)}
          ${infoItem('Inspection Performed By', data.inspectedBy)}
          ${infoItem('Field Name', data.fieldName)}
          ${infoItem('Location', data.location)}
          ${infoItem('Date of Inspection', data.inspectionDate)}
          ${infoItem('Hours on Machine', data.machineHours)}
          ${infoItem('Start Time', data.startTime)}
          ${infoItem('End Time', data.endTime)}
        </div>
      </div>
      <h3 class="report-section-title">System Notes</h3>
      <div class="notes-block">
        ${noteRow('Well Motor Oil Level', data.notes.wellMotorOil)}
        ${noteRow('Drip Oil System', data.notes.dripOilSystem)}
        ${noteRow('Well Panel', data.notes.wellPanel)}
        ${noteRow('Water Supply', data.notes.waterSupply)}
        ${noteRow('Main Control Panel', data.notes.mainControlPanel)}
        ${noteRow('Pivot Foundation', data.notes.pivotFoundation)}
        ${noteRow('Anchoring System', data.notes.anchoringSystem)}
        ${noteRow('Center Point Structure', data.notes.centerPointStructure)}
        ${noteRow('Collector Ring', data.notes.collectorRing)}
        ${noteRow('Tower Boot', data.notes.towerBootNote)}
      </div>
      <h3 class="report-section-title">Tower Findings</h3>
    `;

    const sorted=[...data.towers].sort((a,b)=>a.id-b.id);
    sorted.forEach(tower=>{
      const comps=tower.components||{};
      const keys=Object.keys(comps);
      const hasProblem=keys.some(k => (comps[k]?.status||'good')!=='good');
      if(includeProblemsOnly && !hasProblem) return;

      html += `<div class="tower-card">
        <div class="tower-header-report">Tower ${tower.id}</div>
        ${tower.comment ? `<div class="small-note"><strong>Notes:</strong> ${escapeHtml(tower.comment)}</div>` : ''}
      `;

      if(keys.length===0){
        html += `<div class="small-note">No components were selected on this tower.</div>`;
      } else {
        html += `<table class="report-table">
          <tr><th>Component</th><th>Condition</th><th>Status</th><th>Details</th></tr>`;
        keys.forEach(k=>{
          const c=comps[k]; if(!c) return;
          if(includeProblemsOnly && c.status==='good') return;
          const name=componentConfigs[k]?.label||k;
          const st=c.status||'good';
          const pillClass = st==='good'?'pill-good':(st==='warning'?'pill-warn':'pill-bad');
          const statusText = st==='good'?'Good':(st==='warning'?'Attention Needed':'Needs Repair');
          const detail=c.psi ? `Tire PSI: ${escapeHtml(c.psi)}` : '';
          html += `<tr>
            <td>${escapeHtml(name)}</td>
            <td>${escapeHtml(c.condition||'')}</td>
            <td><span class="status-pill ${pillClass}">${escapeHtml(statusText)}</span></td>
            <td>${escapeHtml(detail)}</td>
          </tr>`;
        });
        html += `</table>`;
      }
      html += `</div>`;
    });

    html += `<div class="small-note">Legend: Green = OK, Yellow = Attention Needed, Red = Needs Repair.</div>`;
    return html;
  }

  function buildFullReportDoc(includeProblemsOnly){
    const css=document.querySelector('style')?.innerHTML||'';
    const body=buildCustomerReportHtml(includeProblemsOnly);
    return `<!DOCTYPE html><html><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Pivot Inspection Report</title><style>${css}</style></head><body style="background:#fff;padding:16px;">${body}</body></html>`;
  }

  
  // ---- Tech-only: Tower Boot / Tower Box state + styling ----
  const towerExtras = {}; // { [towerId]: { boot:'', box:'' } }

  function setSelectClass(selectEl, level){
    selectEl.classList.remove('select-good','select-warn','select-bad');
    if(level==='good') selectEl.classList.add('select-good');
    else if(level==='warn') selectEl.classList.add('select-warn');
    else if(level==='bad') selectEl.classList.add('select-bad');
  }

  function bootLevel(val){
    if(val==='Good') return 'good';
    if(val==='Cracking') return 'warn';
    if(val==='Replace') return 'bad';
    return '';
  }
  function boxLevel(val){
    if(val==='Good') return 'good';
    if(val==='Replace Contactor & Micro-switch') return 'warn';
    if(val==='Cracked Lid') return 'warn';
    if(val==='Replace') return 'bad';
    return '';
  }

  // Patch addTower to wire up the new selects (we hook after each tower is added)
  const _origAddTower = addTower;
  addTower = function(){
    _origAddTower();

    const sections = Array.from(towersContainer.querySelectorAll('.tower-section'));
    const section = sections[sections.length-1];
    const towerId = parseInt(section.dataset.towerId, 10);

    towerExtras[towerId] = towerExtras[towerId] || { boot:'', box:'' };

    const bootSel = section.querySelector('.towerBootSelect');
    const boxSel  = section.querySelector('.towerBoxSelect');

    if(bootSel){
      bootSel.value = towerExtras[towerId].boot || '';
      setSelectClass(bootSel, bootLevel(bootSel.value));
      bootSel.addEventListener('change', () => {
        towerExtras[towerId].boot = bootSel.value;
        setSelectClass(bootSel, bootLevel(bootSel.value));
      });
    }

    if(boxSel){
      boxSel.value = towerExtras[towerId].box || '';
      setSelectClass(boxSel, boxLevel(boxSel.value));
      boxSel.addEventListener('change', () => {
        towerExtras[towerId].box = boxSel.value;
        setSelectClass(boxSel, boxLevel(boxSel.value));
      });
    }
  };

  // Rebuild first tower wiring (since we already called remember: addTower() once earlier)
  // The call below is safe: it will rewire selects for existing towers.
  function wireTowerExtraSelects(){
    towersContainer.querySelectorAll('.tower-section').forEach(section=>{
      const towerId=parseInt(section.dataset.towerId,10);
      towerExtras[towerId]=towerExtras[towerId]||{boot:'',box:''};

      const bootSel=section.querySelector('.towerBootSelect');
      const boxSel=section.querySelector('.towerBoxSelect');

      if(bootSel && !bootSel.dataset.wired){
        bootSel.dataset.wired="1";
        bootSel.value=towerExtras[towerId].boot||'';
        setSelectClass(bootSel, bootLevel(bootSel.value));
        bootSel.addEventListener('change',()=>{ towerExtras[towerId].boot=bootSel.value; setSelectClass(bootSel, bootLevel(bootSel.value)); });
      }
      if(boxSel && !boxSel.dataset.wired){
        boxSel.dataset.wired="1";
        boxSel.value=towerExtras[towerId].box||'';
        setSelectClass(boxSel, boxLevel(boxSel.value));
        boxSel.addEventListener('change',()=>{ towerExtras[towerId].box=boxSel.value; setSelectClass(boxSel, boxLevel(boxSel.value)); });
      }
    });
  }

  // Extend gatherFormData to include tower boot/box
  const _origGather = gatherFormData;
  gatherFormData = function(){
    const data = _origGather();
    data.towers = data.towers.map(t => ({
      ...t,
      tower_boot: towerExtras[t.id]?.boot || '',
      tower_box: towerExtras[t.id]?.box || ''
    }));
    return data;
  };

  function computeDurationMinutes(startTime, endTime){
    if(!startTime || !endTime) return 0;
    const [sh, sm] = startTime.split(':').map(Number);
    const [eh, em] = endTime.split(':').map(Number);
    if([sh,sm,eh,em].some(n => Number.isNaN(n))) return 0;
    let start = sh*60 + sm;
    let end = eh*60 + em;
    if(end < start) end += 24*60; // crosses midnight
    return Math.max(0, end - start);
  }

  function techColor(status){
    if(status==='good') return '#2e7d32';
    if(status==='warning') return '#b08900';
    if(status==='bad') return '#b71c1c';
    return '#495057';
  }

  function buildTechBreadcrumbDoc(){
    const css = document.querySelector('style')?.innerHTML || '';
    const data = gatherFormData();

    const lines = [];
    lines.push(`<div style="font-weight:900;font-size:1.35rem;color:#0b2a4a;">Pivot Inspection ‚Äì Tech Report</div>`);
    lines.push(`<div style="margin:.35rem 0 1rem;color:#495057;">
      <div><b>Customer:</b> ${escapeHtml(data.customerName)}</div>
      <div><b>Field:</b> ${escapeHtml(data.fieldName)}</div>
      <div><b>Location:</b> ${escapeHtml(data.location)}</div>
      <div><b>Tech:</b> ${escapeHtml(data.inspectedBy)}</div>
      <div><b>Date:</b> ${escapeHtml(data.inspectionDate)}</div>
    </div>`);

    data.towers.sort((a,b)=>a.id-b.id).forEach(t=>{
      lines.push(`<div style="margin-top:12px;font-weight:900;color:#1865ab;">Tower ${t.id}</div>`);

      // Tower extras
      if(t.tower_boot){
        const lvl = bootLevel(t.tower_boot);
        lines.push(`<div>‚Ä¢ Tower Boot: <span style="font-weight:900;color:${techColor(lvl==='warn'?'warning':(lvl==='bad'?'bad':'good'))};">${escapeHtml(t.tower_boot)}</span></div>`);
      }
      if(t.tower_box){
        const lvl = boxLevel(t.tower_box);
        const st = (lvl==='warn')?'warning':(lvl==='bad'?'bad':'good');
        lines.push(`<div>‚Ä¢ Tower Box: <span style="font-weight:900;color:${techColor(st)};">${escapeHtml(t.tower_box)}</span></div>`);
      }

      const comps = t.components || {};
      Object.keys(comps).forEach(k=>{
        const c = comps[k];
        const label = componentConfigs[k]?.label || k;
        const st = c.status || 'good';
        const detail = c.psi ? ` (PSI: ${escapeHtml(c.psi)})` : '';
        lines.push(`<div>‚Ä¢ ${escapeHtml(label)}: <span style="font-weight:900;color:${techColor(st)};">${escapeHtml(c.condition || '')}</span>${detail}</div>`);
      });

      if(t.comment){
        lines.push(`<div style="margin-top:4px;color:#495057;"><b>Notes:</b> ${escapeHtml(t.comment)}</div>`);
      }
    });

    const body = `<div style="background:#fff;padding:16px;">${lines.join('')}</div>`;
    return `<!DOCTYPE html><html><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Tech Report</title><style>${css}</style></head><body>${body}</body></html>`;
  }

  async function htmlDocToPdfBase64(docHtml, filenameBase){
    const holder = document.createElement('div');
    holder.style.position='fixed';
    holder.style.left='-10000px';
    holder.style.top='0';
    holder.style.width='1000px';
    holder.innerHTML = docHtml;
    document.body.appendChild(holder);

    const opt = { margin: 0.4, filename: filenameBase + '.pdf', html2canvas: { scale: 2 }, jsPDF: { unit:'in', format:'letter', orientation:'portrait' } };
    const worker = html2pdf().from(holder).set(opt).toPdf();
    const pdf = await worker.get('pdf');
    const blob = pdf.output('blob');

    document.body.removeChild(holder);

    const ab = await blob.arrayBuffer();
    let binary = '';
    const bytes = new Uint8Array(ab);
    const chunk = 0x8000;
    for(let i=0;i<bytes.length;i+=chunk){
      binary += String.fromCharCode.apply(null, bytes.subarray(i,i+chunk));
    }
    return btoa(binary);
  }

  async function uploadPdfToSupabase({inspectionId, kind, filename, base64}){
    // Requires you already have /.netlify/functions/upload-report set up
    const res = await fetch('/.netlify/functions/upload-report', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ inspection_id: inspectionId, kind, filename, contentType:'application/pdf', base64 })
    });
    const text = await res.text().catch(()=> '');
    if(!res.ok) throw new Error(text || ('Upload failed HTTP ' + res.status));
    return JSON.parse(text);
  }

  // ---- Tech Submit ----
  document.getElementById('btnSubmitInspection').addEventListener('click', async () => {
    wireTowerExtraSelects();
    const missing = [];
    const req = [
      ['Customer Name / Company','customerName'],
      ['Field Name','fieldName'],
      ['Inspection Performed By','inspectedBy'],
      ['Location','locationInput'],
      ['Date of Inspection','inspectionDate'],
    ];
    req.forEach(([label,id])=>{
      const v=(document.getElementById(id)?.value||'').trim();
      if(!v) missing.push(label);
    });

    // Require tower boot/box for each tower
    towersContainer.querySelectorAll('.tower-section').forEach(section=>{
      const tid = parseInt(section.dataset.towerId,10);
      const boot = (section.querySelector('.towerBootSelect')?.value||'').trim();
      const box  = (section.querySelector('.towerBoxSelect')?.value||'').trim();
      if(!boot) missing.push(`Tower ${tid}: Tower Boot`);
      if(!box) missing.push(`Tower ${tid}: Tower Box`);
    });

    if(missing.length){
      alert('Missing required fields:\n\n- ' + missing.join('\n- '));
      return;
    }

    if(!confirm('Are you sure you want to submit this inspection?')) return;

    const btn = document.getElementById('btnSubmitInspection');
    const oldText = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'Submitting‚Ä¶';

    try{
      const data = gatherFormData();
      const duration_minutes = computeDurationMinutes(data.startTime, data.endTime);

      // 1) Insert the inspection row (table insert must be working already)
      const insertRes = await fetch('/.netlify/functions/submit-inspection', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          customer_name: (data.customerName||'').trim(),
          location: (data.location||'').trim(),
          performed_by: (data.inspectedBy||'').trim(),
          duration_minutes
        })
      });

      const insertJson = await insertRes.json().catch(()=>null);
      if(!insertRes.ok){
        throw new Error(JSON.stringify(insertJson || {error:'Insert failed', status:insertRes.status}));
      }

      const row = insertJson?.inserted?.[0];
      const inspectionId = row?.id;
      const inspNum = row?.inspection_number ?? '';
      if(!inspectionId) throw new Error('Insert succeeded but did not return inspection id.');

      // 2) Build BOTH report docs
      const customerDoc = buildFullReportDoc(false); // all towers
      const techDoc = buildTechBreadcrumbDoc();

      // 3) Convert to PDF base64
      const safeCustomer = (data.customerName||'customer').replace(/[^a-z0-9]+/gi,'-').replace(/^-+|-+$/g,'');
      const safeField = (data.fieldName||'field').replace(/[^a-z0-9]+/gi,'-').replace(/^-+|-+$/g,'');
      const custFilename = `${safeCustomer}-${safeField}-customerreport.pdf`;
      const techFilename = `${safeCustomer}-${safeField}-techrpt.pdf`;

      const custB64 = await htmlDocToPdfBase64(customerDoc, custFilename.replace(/\.pdf$/,''));
      const techB64 = await htmlDocToPdfBase64(techDoc, techFilename.replace(/\.pdf$/,''));

      // 4) Upload to Storage (requires upload-report Netlify function)
      await uploadPdfToSupabase({ inspectionId, kind:'customer', filename:custFilename, base64:custB64 });
      await uploadPdfToSupabase({ inspectionId, kind:'tech', filename:techFilename, base64:techB64 });

      alert(`Inspection submitted and reports uploaded!${inspNum ? '\\nInspection #: ' + inspNum : ''}`);
      setTimeout(()=>{ window.location.href='customerapp.html'; }, 900);
    }catch(err){
      alert('Submit failed:\n' + (err?.message || String(err)));
    }finally{
      btn.disabled = false;
      btn.textContent = oldText;
    }
  });

  window.addEventListener('load', updateTowerScale);
})();
</script>
</body>
</html>
